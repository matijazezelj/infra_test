# Network Policies for OpenSearch Stack
# Restricts network traffic to only what's necessary
---
# OpenSearch Network Policy - Only allow traffic from Vector and Dashboards
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: opensearch-network-policy
  namespace: opensearch
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: opensearch
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from OpenSearch Dashboards
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: opensearch
          podSelector:
            matchLabels:
              app: opensearch-dashboards
      ports:
        - protocol: TCP
          port: 9200
    # Allow from Vector Aggregator
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: vector
          podSelector:
            matchLabels:
              app.kubernetes.io/name: vector
              app.kubernetes.io/instance: vector-aggregator
      ports:
        - protocol: TCP
          port: 9200
    # Allow inter-node communication (cluster formation)
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: opensearch
      ports:
        - protocol: TCP
          port: 9300
  egress:
    # Allow DNS
    - to:
        - namespaceSelector: {}
          podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: UDP
          port: 53
    # Allow inter-node communication
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: opensearch
      ports:
        - protocol: TCP
          port: 9300
---
# OpenSearch Dashboards Network Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: opensearch-dashboards-network-policy
  namespace: opensearch
spec:
  podSelector:
    matchLabels:
      app: opensearch-dashboards
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from ingress controller (or specific IPs)
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: ingress-nginx
      ports:
        - protocol: TCP
          port: 5601
    # Allow from same namespace for health checks
    - from:
        - podSelector: {}
      ports:
        - protocol: TCP
          port: 5601
  egress:
    # Allow DNS
    - to:
        - namespaceSelector: {}
          podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: UDP
          port: 53
    # Allow to OpenSearch
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: opensearch
      ports:
        - protocol: TCP
          port: 9200
---
# Vector Agent Network Policy (sends to NATS)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: vector-agent-network-policy
  namespace: vector
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: vector
      app.kubernetes.io/instance: vector-agent
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow Prometheus scraping
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: monitoring
      ports:
        - protocol: TCP
          port: 8686
  egress:
    # Allow DNS
    - to:
        - namespaceSelector: {}
          podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: UDP
          port: 53
    # Allow to NATS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: nats
      ports:
        - protocol: TCP
          port: 4222
    # Allow to Kubernetes API (for log collection)
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
      ports:
        - protocol: TCP
          port: 443
---
# Vector Aggregator Network Policy (consumes from NATS, sends to OpenSearch)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: vector-aggregator-network-policy
  namespace: vector
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: vector
      app.kubernetes.io/instance: vector-aggregator
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow Prometheus scraping
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: monitoring
      ports:
        - protocol: TCP
          port: 8686
  egress:
    # Allow DNS
    - to:
        - namespaceSelector: {}
          podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: UDP
          port: 53
    # Allow to NATS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: nats
      ports:
        - protocol: TCP
          port: 4222
    # Allow to OpenSearch
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: opensearch
      ports:
        - protocol: TCP
          port: 9200
---
# NATS Network Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: nats-network-policy
  namespace: nats
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: nats
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from Vector namespace
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: vector
      ports:
        - protocol: TCP
          port: 4222
    # Allow inter-node communication (cluster formation)
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: nats
      ports:
        - protocol: TCP
          port: 6222  # Cluster port
        - protocol: TCP
          port: 4222  # Client port
    # Allow Prometheus scraping
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: monitoring
      ports:
        - protocol: TCP
          port: 7777
  egress:
    # Allow DNS
    - to:
        - namespaceSelector: {}
          podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: UDP
          port: 53
    # Allow inter-node communication
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: nats
      ports:
        - protocol: TCP
          port: 6222
        - protocol: TCP
          port: 4222
